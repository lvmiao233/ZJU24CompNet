---
sidebar_position: 13
title: Lab8 实现一个轻量级的WEB服务器
---

import {Alert} from 'antd';
import FileCard from '@site/src/components/FileCard';
import DeadlineProcess from '@site/src/components/DeadlineProcess';
import { Row, Col } from 'antd';
import MappedCollapse from "@site/src/components/CollapseContent";
import HTTPVersions, {HTTPMethods, HTTPMethodsExtras} from '@site/src/compData/HTTPInfo.js';
import IconHeader from "@site/src/components/IconHeader";
import LinkCard from '@site/src/components/LinkCard';
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

<Alert message="文档尚未编写完成，请先参考实验PPT与报告模板步骤，如对实验有疑问可先钉钉提问，感谢理解" type="warning" showIcon/>
<br/>

<h3 style={{color: '#006d75', marginTop: 0, marginBottom: 8}}>实验资源</h3>

<DeadlineProcess start={'2024-09-21 13:25:00'} end={'2024-12-29 23:59:59'}/>

<Row gutter={[16, 4]} justify="space-between" style={{marginBottom: -25}}>
    <Col xs={24} sm={24} md={12} lg={24} xl={12} xxl={12}>
        <FileCard file_type={'md'} name={'Lab8 实验报告模板 Markdown版本'} size={'26341'} link={require('@site/assets/templete/md/Lab8 实验报告模板.zip').default} />
    </Col>
    <Col xs={24} sm={24} md={12} lg={24} xl={12} xxl={12}>
        <FileCard file_type={'doc'} name={'Lab8 实验报告模板 Word版本'} size={'61440'} link={require('@site/assets/templete/word/实验报告模版_实验8.doc').default} />
    </Col>
    <Col xs={24} sm={24} md={12} lg={24} xl={12} xxl={12}>
    </Col>
</Row>
<br/>
:::important 以下指导仅供参考，在满足实验报告中要求的前提下，我们对你的具体实现方式没有要求，你可以自由进行设计与开发
:::

## 0 实验目的与意义

* 深化知识理解：通过Socket API使用实践，增加对网络应用程序的了解，对网络通信的过程与原理获得更鲜活直接的体验与理解
* 提高开发技能：接触日志工具/版本控制工具/自动化测试工具，锻炼协作开发能力与技巧，增强自主学习能力
* 设计自定义协议：通过自己动手设计网络通信协议，体会数据的编码与解码、错误检测与恢复机制的作用与原则
* 实现并发处理：学会处理并发客户端连接，提高处理并发请求的能力，适应当下计算资源并行化与网络应用高并发化的发展趋势

## 1 初识HTTP——概念浅析

HTTP，即超文本传输协议（Hyper Text Transfer Protocol），定义了客户端（通常是Web浏览器）与服务器之间请求和响应的格式。HTTP的简单与强大使其成为了互联网上应用最广泛的网络协议之一，无论是访问网页，还是在线APP加载，都有HTTP的身影

在这一部分，我们将带你了解HTTP相关的基本概念，你可以边学习边打开开发者工具（Ctrl + Shift + J 或 F12），选择网络Tab后刷新页面重载，观察网页加载过程发生的动作，加深对相应知识的理解

![image-20241028143838447](img/Lab8/image-20241028143838447.png)

如果你的列表中显示的信息较少，可以右键顶部字段（如“名称”），并勾选想要查看的字段，我们推荐你选择方法、状态、域

为了便于你清晰地观察和筛选头字段，开发人员工具有时会对头部进行结构化解析，这个过程可能会丢弃HTTP版本等信息，你可以开启Raw开关查看原始的响应（Edge不支持该特性）

![image-20241028142906869](img/Lab8/image-20241028142906869.png)

关于更多信息，请参见你所使用的浏览器的开发者文档

<Tabs className="unique-tabs"  groupId="browser">
    <TabItem value="Microsoft Edge">
        <LinkCard title="网络功能参考" url="https://learn.microsoft.com/zh-cn/microsoft-edge/devtools-guide-chromium/network/reference"  icon="https://learn.microsoft.com/favicon.ico">
            {"网络功能参考 - Microsoft Edge Developer Documentation | Microsoft Learn"}
        </LinkCard>
    </TabItem>
    <TabItem value="Google Chrome">
        <LinkCard title="网络功能参考" url="https://developer.chrome.com/docs/devtools/network/reference?hl=zh-cn"  icon="
https://www.gstatic.com/devrel-devsite/prod/v0e3f58103119c4df6fb3c3977dcfd0cb669bdf6385f895761c1853a4b0b11be9/chrome/images/favicon.png">
            {"网络功能参考 | Chrome Dev Tools | Chrome for Developers"}
        </LinkCard>
    </TabItem>
    <TabItem value="Mozilla Firefox">
        <LinkCard title="Network Monitor" url="https://firefox-source-docs.mozilla.org/devtools-user/network_monitor/"  icon="https://firefox-source-docs.mozilla.org/_static/firefox.ico">
            {"Network Monitor - Firefox  Source Docs Documentation"}
        </LinkCard>
    </TabItem>
</Tabs>


### 1.1 HTTP版本演进

过去三十年间，为了适应通讯与计算技术的迅猛发展，万维网联盟（W3C）和互联网工程任务组（IETF）也在对HTTP进行持续的迭代，目前最新的HTTP版本是HTTP/3.0

在实验中，你只需要实现HTTP/1.0版本的部分基本特性即可，其他HTTP版本的特性仅供你延伸学习，我们的理论课程也会覆盖这部分内容

<MappedCollapse items={HTTPVersions} defaultActiveKey={['HTTP/1.0']} style={{marginBottom: 12}}/>
<IconHeader type="tryout" title="动手试1 观察自己加载网页使用的HTTP版本" />

选中一个网络请求，查看其版本（Edge不支持该查看，需要使用Wireshark抓包）

![image-20241028145513246](img/Lab8/image-20241028145513246.png)

实际上，我们浏览网页时使用的HTTP版本与客户端-中间网络设备-服务端中每个环节的支持情况都息息相关，尽管HTTP/3带来了各方面的显著优化，但架构的调整也使得互联网尚需时日才能更好地兼容与适配，目前最主流使用的版本仍然是HTTP/2

<div style={{position: "relative", width:'100%', height: '400px'}}>
    <iframe style={{position: 'absolute', width: '100%', height: '100%'}} src="https://radar.cloudflare.com/embed/HttpVersionXY?botClass=&chartState=%7B%22showAnnotations%22%3Atrue%2C%22xy.hiddenSeries%22%3A%5B%5D%2C%22xy.highlightedSeries%22%3Anull%2C%22xy.previousVisible%22%3Atrue%7D" title="Cloudflare Radar - HTTP/1.x vs. HTTP/2 vs. HTTP/3" loading="lazy"></iframe>
</div>





### 1.2 统一资源标识符 URI

随着互联网的发展，人类每天在互联网上产生的数据体量也在急速膨胀，面对浩如烟海的资源，如果没有合理的方式对其进行标记，那么我们的检索和访问就会无异于大海捞针






### 1.3 HTTP方法

在HTTP协议中，方法是指客户端与服务器之间交互时使用的**动词**，它们定义了请求的目的和期望的行为

通过这些方法，客户端可以向服务器表达不同的操作意图，如获取资源、提交数据或删除资源等，一般来说，我们最为常用的是GET和POST方法，另一些方法在特定情况下会非常有用

<MappedCollapse items={HTTPMethods} defaultActiveKey={['GET方法']} extras={HTTPMethodsExtras}/>
<IconHeader type="tryout" title="动手试3 使用不同HTTP方法并观察请求与响应" />
<br/>

:::important 幂等性

幂等性是指连续多次相同的请求对服务器状态**不会造成额外的影响**。例如，删除某个文件的操作是幂等的，即无论删除请求发送多少次，最终的结果都是该文件在服务器上处于已删除状态，不会导致服务器凭空生成新文件或恢复已删除的文件等“闹鬼”一样的现象

对于我们不甚可靠的网络环境来说，幂等性相当重要，因为请求可能会因为各种原因（如网络延迟、重试机制等）而被重复发送；幂等性能够确保数据的**一致性和可预测性**，即使不慎进行了重复操作，也能保证业务的安全进行
:::

|  方法  | GET / HEAD / OPTION  | PUT / DELETE | POST / PATCH |
| :----: | :--: | :--: | :--: |
| 幂等性 |  √   |   √   |  ×   |
|  缓存  |  √   |  ×   |  ×   |



每种HTTP方法都有其特定的设计目的和使用场景，正确选择和使用这些方法对于构建高效、可靠和安全的Web应用至关重要。理解这些方法的工作原理及其差异，有助于我们在设计Web服务器时做出更加合理的决策。例如，在处理用户登录请求时，考虑到安全性，应选择POST方法来提交用户凭证；而在搜索功能中，如果查询条件简单且不涉及敏感信息，则可以考虑使用GET方法来方便地保存搜索链接。通过合理利用HTTP方法，我们可以构建更加符合REST架构原则的Web服务，提高系统的可扩展性和互操作性。

### 1.4 HTTP请求结构介绍

HTTP请求是由客户端发送给服务器的消息，用于发起一次网络请求。每个HTTP请求都由三部分组成：请求行、请求头和请求体。下面我们将详细介绍这三个组成部分，并重点讲解一些重要的请求头字段。

#### 整体结构

1. **请求行 (Request Line)**
   - 请求行包括方法、请求的目标URI和使用的HTTP版本，如： `GET /index.html HTTP/1.1`
   - 方法：如 `GET`、`POST`、`PUT` 等，表示请求类型
   - 目标URI：指定请求的资源位置
   - HTTP版本：如 `HTTP/1.1`，表示使用的HTTP协议版本

2. **请求头 (Request Headers)**
   - 请求头是一系列键值对，每对以冒号分隔，每行一对，用于提供关于请求的额外信息。如：

     ```HTTP
     Host: www.example.com
     User-Agent: Mozilla/5.0 ...
     Accept: text/html,application/xhtml+xml,...
     ```
   
3. **请求体 (Request Body)**
   - 请求体是可选的，用于携带请求的数据，如表单数据或文件上传
   
     对于 `GET` 请求，请求体通常是空的；而对于 `POST`、`PUT` 等方法，请求体则包含了要提交的数据。例如： `username=johndoe&password=s3cre7`

#### 头字段介绍

以下是几个最重要的请求头字段及其作用：

1. **Host** 例：`Host: www.example.com`

   - 指定请求的主机名和端口号。这个字段在HTTP/1.1中是必需的，因为它帮助服务器区分不同的虚拟主机。

2. **Content-Type** 例：`Content-Type: application/x-www-form-urlencoded`

   - 指示请求体中的数据格式，对于 `POST`、`PUT` 等方法尤为重要，因为服务器需要知道如何解析请求体中的数据

3. **Content-Length** 例：`Content-Length: 34`

   - 表示请求体的长度，以字节为单位，帮助服务器知道何时读取完所有请求数据

4. **User-Agent** 例：`User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.121 Safari/537.36`

   - 描述发出请求的客户端软件的信息，包括浏览器名称、版本和其他相关信息，为了解决历史兼容问题以及与其他浏览器进行竞争，该字段看起来可能非常抽象离谱，如果对这座屎山的堆积过程感兴趣，你可以浏览：
   - 网站

5. **Accept** 例：`Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8`

   - 指示客户端能够接受的内容类型。服务器可以根据这个字段来决定返回哪种格式的数据

6. **Authorization** 例：`Authorization: Basic dXNlcm5hbWU6cGFzc3dvcmQ=`

   - 用于提供访问受保护资源所需的认证信息，通常采用Base64编码的形式

7. **Cookie** 例：`Cookie: sessionid=abc123xyz`

   - 用于存储客户端的状态信息，如会话ID。每次请求时，客户端会自动将之前设置的Cookie发送回服务器

8. **Referer** 例：`Referer: http://www.example.com/index.html`

   :::info 这个字段的错误拼写是为了保持历史兼容而有意为之的，不是实验文档错误
   :::

   - 指示当前请求是从哪个页面链接过来的，通常用于统计分析或防止盗链

9. **Accept-Encoding** 例：`Accept-Encoding: gzip, deflate`

   - 指示客户端支持的内容编码方式，如 `gzip`、`deflate` 等，服务器可以根据这个字段来压缩响应数据，从而减少传输时间

10. **Connection** 例： `Connection: keep-alive`
    - 控制连接的行为，如是否保持连接，常用的值有 `keep-alive` 和 `close`
